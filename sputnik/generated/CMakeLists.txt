# NB: <codegen> get all subdir in the generated folder.
MACRO(SUBDIRLIST result curdir)
  # code from https://stackoverflow.com/questions/7787823/cmake-how-to-get-the-name-of-all-subdirectories-of-a-directory
  FILE(GLOB children RELATIVE ${curdir} ${curdir}/*)
  SET(dirlist "")
  FOREACH(child ${children})
    IF(IS_DIRECTORY ${curdir}/${child})
      LIST(APPEND dirlist ${child})
    ENDIF()
  ENDFOREACH()
  SET(${result} ${dirlist})
ENDMACRO()

# NB: <codegen> add_subdirectory here for custom op, e.g., custom_spmm|sddmm
# we need to store variables from parent scope to propagate them to cmake process in subdirectories
set(SPUTNIK_SRCS ${SPUTNIK_SRCS})
set(SPUTNIK_CUSTOM_OP_DIR_NAME_LISTS ${SPUTNIK_CUSTOM_OP_DIR_NAME_LISTS})
set(SPUTNIK_CUSTOM_OP_TEST_SRCS_LISTS ${SPUTNIK_CUSTOM_OP_TEST_SRCS_LISTS})
set(SPUTNIK_CUSTOM_OP_BENCHMARK_SRCS_LISTS ${SPUTNIK_CUSTOM_OP_BENCHMARK_SRCS_LISTS})
# add_subdirectory(custom_spmm)
# add_subdirectory(custom_sddmm)
FILE(GLOB children RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/*)
FOREACH(child ${children})
    MESSAGE(STATUS "child: ${child}")
    IF(IS_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${child})
      # LIST(APPEND dirlist ${child})
      MESSAGE(STATUS "add_subdirectory(${child})")
      add_subdirectory(${child})
    ENDIF()
ENDFOREACH()
# similarly, we need to pass updated variables from cmake process in subdirectories to parent folder
set(SPUTNIK_CUSTOM_OP_DIR_NAME_LISTS ${SPUTNIK_CUSTOM_OP_DIR_NAME_LISTS} PARENT_SCOPE)
set(SPUTNIK_CUSTOM_OP_TEST_SRCS_LISTS ${SPUTNIK_CUSTOM_OP_TEST_SRCS_LISTS} PARENT_SCOPE)
set(SPUTNIK_CUSTOM_OP_BENCHMARK_SRCS_LISTS ${SPUTNIK_CUSTOM_OP_BENCHMARK_SRCS_LISTS} PARENT_SCOPE)
set(SPUTNIK_SRCS ${SPUTNIK_SRCS} PARENT_SCOPE)
